

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>Trading Plan Pro - Layer 2</title>
<link rel="icon" type="image/png" href="63281.png">
<link rel="apple-touch-icon" href="63281.png">
<link rel="manifest" href="data:application/manifest+json,{
  'name':'TradeCalc',
  'short_name':'TradeCalc',
  'start_url':'.',
  'display':'standalone',
  'background_color':'#0a0a0c',
  'theme_color':'#00d2ff',
  'icons': [
    {
      'src': '63281.png',
      'sizes': '192x192',
      'type': 'image/png'
    },
    {
      'src': '63281.png',
      'sizes': '512x512',
      'type': 'image/png'
    }
  ]
}">




    <style>
        :root {
            --bg-color: #0a0a0c;
            --card-bg: rgba(255, 255, 255, 0.05);
            --neon-blue: #00d2ff;
            --neon-green: #39ff14;
            --neon-red: #ff3131;
            --neon-yellow: #f4ea11;
            --text-gray: #a0a0a0;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: white; margin: 0; padding: 10px; padding-bottom: 120px; overflow-x: hidden; }

        /* Typography */
        h2, h3 { color: var(--neon-blue); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-right: 3px solid var(--neon-blue); padding-right: 10px; }

        /* Glassmorphism Cards */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        /* Layer System */
        #layer-2 { display: none; }
        .hidden { display: none !important; }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        label { display: block; color: var(--text-gray); font-size: 0.9rem; margin-bottom: 5px; }
        input, select {
            width: 100%;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
        }
        input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0,210,255,0.3); }

        /* Buttons Grid */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .mode-btn {
            padding: 15px 5px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-gray);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: 0.3s;
        }
        .mode-btn.active {
            background: rgba(0, 210, 255, 0.2);
            border-color: var(--neon-blue);
            color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0,210,255,0.4);
        }

        /* Checklist Buttons */
        .check-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .check-btns { display: flex; gap: 5px; }
        .score-btn {
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--glass-border);
            background: #222; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .score-btn.yes.active { background: var(--neon-green); color: black; box-shadow: 0 0 10px var(--neon-green); }
        .score-btn.no.active { background: var(--neon-red); color: white; box-shadow: 0 0 10px var(--neon-red); }
        .score-btn.active { transform: scale(1.1); border: 2px solid white; }


        /* Live Lot Display */
        .live-lot-box { text-align: center; border: 2px dashed var(--neon-blue); padding: 15px; margin-top: 10px; }
        .lot-val { font-size: 3.5rem; font-weight: 900; color: var(--neon-blue); text-shadow: 0 0 20px var(--neon-blue); line-height: 1; }

        /* Risk Badges */
        .risk-badge { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 10px; font-size: 1.2rem; }
        .risk-low { background: rgba(57, 255, 20, 0.2); color: var(--neon-green); border: 1px solid var(--neon-green); }
        .risk-mid { background: rgba(244, 234, 17, 0.2); color: var(--neon-yellow); border: 1px solid var(--neon-yellow); }
        .risk-high { background: rgba(255, 49, 49, 0.2); color: var(--neon-red); border: 1px solid var(--neon-red); }

        /* Sticky Bottom */
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(10, 10, 12, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--neon-blue);
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            z-index: 1000;
        }
        .footer-item { text-align: center; font-size: 0.7rem; color: var(--text-gray); }
        .footer-item span { display: block; color: white; font-weight: bold; font-size: 0.9rem; }

        /* Overlay Lock */
        #lock-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: var(--neon-red); text-align: center; padding: 20px;
        }

        .summary-card { border-left: 5px solid var(--neon-blue); margin-top: 10px; font-family: monospace; }
        .pos-value { color: var(--neon-green); }
        .neg-value { color: var(--neon-red); }
.delete-btn {
    background: none;
    border: none;
    color: var(--neon-red);
    cursor: pointer;
    font-size: 1.2rem;
    float: left; /* Ø³Ø·Ù„ Ø¢Ø´ØºØ§Ù„ Ø³Ù…Øª Ú†Ù¾ Ú©Ø§Ø±Øª Ø¨Ø§Ø´Ø¯ */
    padding: 0 5px;
    transition: 0.3s;
}
.delete-btn:hover {
    transform: scale(1.2);
    text-shadow: 0 0 10px var(--neon-red);
}
/* Ø¨Ø±Ø§ÛŒ Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ */
.page-hidden { display: none !important; }

/* Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒÙ… ØµÙØ­Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯ */
/* Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ -page Ø´ÙˆØ¯ */
.-page {
    position: fixed;
    inset: 0;
    background: var(--bg-color);
    z-index: 3000;
    /* Ø§ÛŒÙ† Ù¾Ø¯ÛŒÙ†Ú¯ 100 Ù¾ÛŒÚ©Ø³Ù„ÛŒ Ø§Ø² Ø±ÙØªÙ† Ù…Ø­ØªÙˆØ§ Ø²ÛŒØ± Ù‡Ø¯Ø± Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ */
    padding: 100px 20px 20px 20px !important; 
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.page-hidden {
    display: none !important;
}



/* Û². Ø§Ø³ØªØ§ÛŒÙ„ ØµÙØ­Ù‡ ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± */


/* Û³. Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø± ØµÙØ­Ø§Øª Ø¬Ø¯ÛŒØ¯ */
.back-btn {
    width: 100%;
    margin-bottom: 20px;
    background: rgba(255, 49, 49, 0.1);
    color: var(--neon-red);
    border: 1px solid var(--neon-red);
}

/* ÙˆÙ‚ØªÛŒ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ SweetAlert Ø±Ø§ Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ø¨Ø¨Ø± ØªØ§ Ø²ÛŒØ± Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù†Ø±ÙˆØ¯ */
.swal2-container {
    height: 100dvh !important; /* Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© */
}

.swal2-popup {
    margin-bottom: 150px !important; /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù† Ø¨Ø§Ù„Ø§ÛŒ Ú©ÛŒØ¨ÙˆØ±Ø¯ */
}

/* Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
@media screen and (max-height: 500px) {
    .swal2-popup {
        margin-bottom: 50px !important;
        font-size: 0.8rem !important;
    }
}




    </style>
</head>

<body>
  
  <div style="position: sticky; top: 0; z-index: 4000; background: #1a1a1a; display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--neon-blue); height: 60px;">
    <div id="back-icon" onclick="closeAllPages()" style="display: none; cursor: pointer; background: rgba(255, 49, 49, 0.1); width: 40px; height: 40px; border-radius: 8px; align-items: center; justify-content: center; border: 1px solid var(--neon-red); margin-left: 10px;">
        <span style="color: var(--neon-red); font-size: 1.2rem;">â¬…</span>
    </div>
    
    <div id="menu-icon-container" onclick="toggleMenu()" style="display: flex; cursor: pointer; background: var(--card-bg); width: 40px; height: 40px; border-radius: 8px; align-items: center; justify-content: center; border: 1px solid var(--neon-blue);">
        <span style="color: var(--neon-blue); font-size: 1.5rem;">â˜°</span>
    </div>

    <div style="flex-grow: 1; text-align: center; color: var(--neon-blue); font-weight: bold; font-size: 1.1rem; letter-spacing: 1px;">
        TRADING PLAN PRO
    </div>
    <div style="width: 40px;"></div> 
</div>


<div id="side-menu" style="position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: rgba(10, 10, 12, 0.98); backdrop-filter: blur(15px); z-index: 4500; transition: 0.3s; border-right: 1px solid var(--neon-blue); padding: 20px; display: flex; flex-direction: column; box-shadow: 5px 0 20px rgba(0,0,0,0.5);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h3 style="margin: 0; font-size: 1.1rem;">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡</h3>
        <span onclick="toggleMenu()" style="cursor: pointer; color: var(--neon-red); font-size: 1.2rem;">âœ–</span>
    </div>
    
    <div class="menu-item" onclick="openPage('vault-page'); toggleMenu();" style="padding: 15px; border-radius: 10px; background: rgba(0, 210, 255, 0.1); margin-bottom: 10px; cursor: pointer; border: 1px solid var(--neon-blue);">
        <span style="display: block; color: var(--neon-blue);">ğŸ’ Ø®Ø²Ø§Ù†Ù‡ Ù†Ø¦ÙˆÙ† (Vault)</span>
        <small style="color: gray; font-size: 0.7rem;">Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡ Ú©Ù„ Ùˆ ÙˆØ§Ø±ÛŒØ²/Ø¨Ø±Ø¯Ø§Ø´Øª</small>
    </div>

    <div class="menu-item" onclick="importBackup()" style="padding: 15px; border-radius: 10px; background: rgba(255,255,255,0.05); margin-bottom: 10px; cursor: pointer; border: 1px solid #333;">
        <span style="display: block; color: var(--neon-yellow);">ğŸ“¥ ÙˆØ±ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Import)</span>
        <small style="color: gray; font-size: 0.7rem;">Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² ÙØ§ÛŒÙ„ Ù‚Ø¨Ù„ÛŒ</small>
    </div>

    <div class="menu-item" onclick="exportBackup()" style="padding: 15px; border-radius: 10px; background: rgba(255,255,255,0.05); margin-bottom: 10px; cursor: pointer; border: 1px solid #333;">
        <span style="display: block; color: var(--neon-green);">ğŸ“¤ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ (Backup)</span>
        <small style="color: gray; font-size: 0.7rem;">Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„ Ø§Ø² ØªÙ…Ø§Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª</small>
    </div>

    <div class="menu-item" onclick="exportToExcel()" style="padding: 15px; border-radius: 10px; background: rgba(57, 255, 20, 0.05); margin-bottom: 10px; cursor: pointer; border: 1px solid rgba(57, 255, 20, 0.2);">
        <span style="display: block; color: var(--neon-green);">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ (Excel)</span>
        <small style="color: gray; font-size: 0.7rem;">Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ú¯Ø²Ø§Ø±Ø´ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´</small>
    </div>

    <div style="margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid #333;">
        <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: #888; margin-bottom: 6px;">
            <span>ÙˆØ¶Ø¹ÛŒØª Ø­Ø§ÙØ¸Ù‡ (Storage)</span>
            <span id="storage-percent" style="color: var(--neon-blue);">0%</span>
        </div>
        <div style="width: 100%; height: 4px; background: #111; border-radius: 2px; overflow: hidden;">
            <div id="storage-bar" style="width: 0%; height: 100%; background: var(--neon-blue); transition: 0.5s; box-shadow: 0 0 5px var(--neon-blue);"></div>
        </div>
    </div>

    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #333; font-size: 0.7rem; color: #555; text-align: center;">
        Trading Plan Pro - v2.1
    </div>
</div>


<div id="menu-overlay" onclick="toggleMenu()" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 4400; display: none;"></div>

  <div id="history-page" class="-page page-hidden">
    <div id="-history-content"></div>
</div>

<div id="chart-page" class="-page page-hidden">
    <div class="glass-card" style="margin-bottom: 15px; padding: 15px;">
        <h3 style="font-size: 0.9rem; margin-bottom: 10px; border-right-color: var(--neon-yellow);">ğŸ“… ÙÛŒÙ„ØªØ± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label style="font-size: 0.7rem;">Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                <input type="date" id="filter-from" onchange="MainChart()" style="padding: 8px; font-size: 0.8rem; background: rgba(0,0,0,0.3); color:white; border:1px solid #444; width:100%;">
            </div>
            <div>
                <label style="font-size: 0.7rem;">ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                <input type="date" id="filter-to" onchange="MainChart()" style="padding: 8px; font-size: 0.8rem; background: rgba(0,0,0,0.3); color:white; border:1px solid #444; width:100%;">
            </div>
        </div>
        <button class="mode-btn" onclick="resetChartFilter()" style="width: 100%; margin-top: 10px; font-size: 0.7rem; padding: 8px; border-color: var(--text-gray);">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡ (Ø±ÛŒØ³Øª ÙÛŒÙ„ØªØ±)</button>
    </div>

    <div id="chart-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;"></div>

    <div class="glass-card" style="flex-grow: 1; min-height: 350px;">
        <h3 style="border-right-color: var(--neon-green); font-size: 0.9rem;">ØªØ­Ù„ÛŒÙ„ Ø±Ø´Ø¯ Ø³Ø±Ù…Ø§ÛŒÙ‡</h3>
        <div style="position: relative; height: 280px; width: 100%;">
            <canvas id="equityChartMain"></canvas>
        </div>
    </div>
</div>

<div id="vault-page" class="-page page-hidden">
    <div class="glass-card" style="border-bottom: 2px solid var(--neon-blue); padding: 10px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <small style="color: var(--text-gray);">ğŸ’ Total Asset (Ø§Ø±Ø²Ø´ Ú©Ù„)</small>
            <div id="v-total-asset" style="font-size: 2.2rem; font-weight: 900; color: #fff; text-shadow: 0 0 15px var(--neon-blue);">$0.00</div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div style="background: rgba(57, 255, 20, 0.05); padding: 10px; border-radius: 10px; border: 1px solid rgba(57, 255, 20, 0.2); text-align: center;">
                <small style="color: var(--neon-green);">ğŸ¦ Safe Vault</small>
                <div id="v-safe-vault" style="font-size: 1.1rem; font-weight: bold;">$0</div>
            </div>
            <div style="background: rgba(0, 210, 255, 0.05); padding: 10px; border-radius: 10px; border: 1px solid rgba(0, 210, 255, 0.2); text-align: center;">
                <small style="color: var(--neon-blue);">âš¡ In Margin</small>
                <div id="v-in-margin" style="font-size: 1.1rem; font-weight: bold;">$0</div>
            </div>
        </div>
        
        <div style="margin-top: 10px; background: rgba(255,255,255,0.03); padding: 5px; border-radius: 8px; text-align: center;">
            <small style="color: var(--text-gray);">ğŸ“Š Ù…Ø¨Ù†Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² (Day Start): </small>
            <span id="v-day-start" style="color: var(--neon-yellow); font-weight: bold;">$0</span>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
<button type="button" class="mode-btn" onclick="transferFlow('toMargin', event)" style="border-color: var(--neon-blue); color: var(--neon-blue); font-size: 0.75rem;">âš¡ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Margin</button>
<button type="button" class="mode-btn" onclick="transferFlow('toVault', event)" style="border-color: var(--neon-green); color: var(--neon-green); font-size: 0.75rem;">ğŸ¦ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Margin</button>

    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
        <button class="mode-btn" onclick="vaultTransaction('deposit')" style="background: rgba(57, 255, 20, 0.1); border-color: var(--neon-green); color: var(--neon-green);">â• ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ø®Ø²Ø§Ù†Ù‡</button>
        <button class="mode-btn" onclick="vaultTransaction('withdraw')" style="background: rgba(255, 49, 49, 0.1); border-color: var(--neon-red); color: var(--neon-red);">â– Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø®Ø²Ø§Ù†Ù‡</button>
    </div>

    <div id="vault-history-list"></div>
</div>




<div id="lock-screen">
    <h1 style="font-size: 3rem;">â›”</h1>
    <h2>ØªÙˆÙ‚Ù Ù…Ø¹Ø§Ù…Ù„Ù‡</h2>
    <p>Ø±ÛŒØ³Ú© Ø±ÙˆØ²Ø§Ù†Ù‡ Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.</p>
    <button class="mode-btn active" onclick="document.getElementById('lock-screen').style.display='none'" style="margin-top: 20px;">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ø±Ø§ÛŒ Ø§ØµÙ„Ø§Ø­ ÛŒØ§ Ø­Ø°Ù</button>
</div>

<div id="layer-1" class="glass-card">
    <h3>Ù„Ø§ÛŒÙ‡ Û±: Ø¢Ù…Ø§Ø¯Ú¯ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆØ²</h3>
    <div id="l1-items"></div>
    <div class="risk-badge" id="l1-score-box" style="margin-top: 20px; border-color: gray; color: gray;">
        Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„: <span id="l1-total">0</span> / 15
    </div>
    <button id="enter-layer2-btn" class="mode-btn active" onclick="goToLayer2()" style="width:100%; margin-top: 20px; display: none;">
        ğŸš€ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²Ø§Ø±
    </button>
</div>

<div id="layer-2" style="display:none;">
    <div class="btn-grid">
        <button class="mode-btn" onclick="setMode('range')">Ø¨Ø§Ø²Ø§Ø± Ø±Ù†Ø¬</button>
        <button class="mode-btn" onclick="setMode('trend')">Ø¨Ø§Ø²Ø§Ø± Ø±ÙˆÙ†Ø¯</button>
        <button class="mode-btn" onclick="setMode('scalp')">Ø®ÛŒÙ„ÛŒ Ø§Ø³Ú©Ù„Ù¾</button>
    </div>

    <div class="glass-card">
        <div class="input-group">
        
<label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø± Ù…Ø§Ø±Ø¬ÛŒÙ† (In Margin $)</label>

           <input type="number" id="balance" onblur="calculateAll(); checkVaultBalance();">


        </div>
        <div class="input-group">
            <label>Ø­Ø¯ Ø¶Ø±Ø± (SL) Ø¨Ù‡ Ù¾ÛŒÙ¾Øª</label>
            <input type="number" id="sl-pipette" placeholder="Ù…Ø«Ù„Ø§Ù‹ 100" oninput="calculateAll()">
        </div>
        <div class="live-lot-box">
            <label>Ù„Ø§Øª ÙˆØ±ÙˆØ¯ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</label>
            <div class="lot-val" id="top-lot">0.000</div>
            <div style="margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 5px;">
                <small style="color: var(--text-gray);">Ø­Ø¯ Ø¶Ø±Ø± Ù…Ø¹Ø§Ø¯Ù„:</small>
                <span id="sl-dollar-display" style="color: var(--neon-red); font-weight: bold;">0.00</span> 
                <small style="color: var(--neon-red);">$</small>
            </div>
        </div>
    </div>

    <div id="scoring-sections">
        <div class="glass-card"><h3>ØªØ£ÛŒÛŒØ¯ ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…</h3><div id="tf-list"></div></div>
        <div class="glass-card"><h3>Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯</h3><div id="trend-list"></div></div>
        <div class="glass-card">
            <h3>Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§</h3>
            <div class="check-item">
                <span>ACD Ù…Ø§Ø±Ú© ÙÛŒØ´Ø±</span>
                <div class="check-btns">
                    <button class="score-btn yes" onclick="setScore('acd', 10, this)">âœ”</button>
                    <button class="score-btn no" onclick="setScore('acd', 0, this)">âœ–</button>
                </div>
            </div>
            <div class="input-group">
                <label>Ù¾Ø±Ø§ÛŒØ³ Ø§Ú©Ø´Ù†</label>
                <select id="pa-select" onchange="checkLayerAndCalc()">
                    <option value="0">Ø¨Ø¯ÙˆÙ† ØªØ£ÛŒÛŒØ¯</option>
                    <option value="15">EOC (15 Ø§Ù…ØªÛŒØ§Ø²)</option>
                    <option value="5">EOW (5 Ø§Ù…ØªÛŒØ§Ø²)</option>
                </select>
            </div>
            <div class="input-group" style="margin-top:10px;">
                <label>Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…Ø§ÛŒÙ†Ø±</label>
                <select id="miner-select" onchange="checkLayerAndCalc()">
                    <option value="0">Ø¨Ø¯ÙˆÙ† ØªØ£ÛŒÛŒØ¯</option>
                    <option value="15">EOC (15 Ø§Ù…ØªÛŒØ§Ø²)</option>
                    <option value="5">EOW (5 Ø§Ù…ØªÛŒØ§Ø²)</option>
                </select>
            </div>
        </div>
        <div class="glass-card"><h3>Ø³Ø§ÛŒØ± ØªØ£ÛŒÛŒØ¯Ù‡Ø§</h3><div id="other-list"></div></div>
    </div>

    <div id="today-trades-section" class="glass-card" style="border-top: 2px solid var(--neon-blue);">
    <div id="trade-history-today"></div>
</div>

    <div class="glass-card">
        <h3>Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡ Ù…Ø¹Ø§Ù…Ù„Ù‡</h3>
        <div class="input-group">
            <label>Ø³ÙˆØ¯ ÛŒØ§ Ø¶Ø±Ø± Ø¯Ù„Ø§Ø±ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ</label>
            <input type="number" id="trade-result" placeholder="Ù…Ø«Ø¨Øª Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ¯ØŒ Ù…Ù†ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø¶Ø±Ø±" step="0.01">
        </div>
        
        <div class="input-group">
        <label>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ØªØ±ÛŒØ¯ (Ø¹Ù„Øª ÙˆØ±ÙˆØ¯ ÛŒØ§ Ø¯Ø±Ø³ ØªØ±ÛŒØ¯)</label>
        <input type="text" id="trade-note" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø®Ø±ÙˆØ¬ Ù¾Ù„Ù‡â€ŒØ§ÛŒ ÛŒØ§ Ù†Ù‚Ø¶ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ">
    </div>
        
        <button class="mode-btn active" style="width:100%; margin-bottom: 10px;" onclick="saveTrade()">Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ù…Ø±ÙˆØ²</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
            <button class="mode-btn" onclick="openPage('history-page')" style="border-color: var(--neon-yellow); color: var(--neon-yellow); padding: 15px;">ğŸ“œ Ú©Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
            <button class="mode-btn" onclick="openPage('chart-page')" style="border-color: var(--neon-green); color: var(--neon-green); padding: 15px;">ğŸ“Š Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ù…ÙˆØ¯Ø§Ø±</button>
        </div>
        <button class="mode-btn" onclick="hardReset()" style="width:100%; margin-top: 15px; border-color: var(--neon-red); color: var(--neon-red); background: rgba(255, 49, 49, 0.1); font-size: 0.7rem;">âš ï¸ Ø±ÛŒØ³Øª Ú©Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
    </div>
</div>
<div class="sticky-footer" id="sticky-bar">
    <div class="footer-item">Ø±ÛŒØ³Ú©: <span id="f-risk">0%</span></div>
    <div class="footer-item">Ø§Ù…ØªÛŒØ§Ø²: <span id="f-score">0</span></div>
    <div class="footer-item" style="border: 1px solid rgba(0,210,255,0.2); border-radius: 5px; background: rgba(255,255,255,0.03);">
        Ø§Ø¹ØªØ¨Ø§Ø± SL: <span id="f-sl-credit" style="color:var(--neon-yellow); font-size: 1.1rem; font-weight: bold;">0</span>
    </div>
    <div class="footer-item">Ø³ÙˆØ¯ Ø§Ù…Ø±ÙˆØ²: <span id="f-daily-pnl">0</span></div>

    <div class="footer-item">Ù†ÙˆØ¹: <span id="f-mode">-</span></div>
    <div class="footer-item">Ù„Ø§Øª: <span id="f-lot">0.000</span></div>
    <div class="footer-item">Ø´Ø±ÙˆØ¹ Ø±ÙˆØ²: <span id="f-start-bal">0</span></div>
    <div class="footer-item">Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø±ÛŒØ³Ú©: <span id="f-rem-risk" style="color:var(--neon-green);">5%</span></div>
</div>


<input type="file" id="hidden-file-input" style="display:none" accept=".json">




<script>
  const Sound = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    
    play(type) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);

        const now = this.ctx.currentTime;

        if (type === 'click') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.exponentialRampToValueAtTime(200, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } 
        else if (type === 'success') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        }
        else if (type === 'error') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.4);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.start(now);
            osc.stop(now + 0.4);
        }
    }
};

  
           // --- Data Structures ---
let state = {
    dayStartBalance: 0,
    lastTradeDate: null, 
    consumedRisk: 0,
    trades: [],
    layer1Complete: false,
    mode: 'range', 
    balance: 0,
    sl: 0,
    scores: {},
    dailyRiskLimit: 5.0,
    callMarginCount: 0,
    lockAlertShown: false
};


// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ø¨Ø®Ø´ state
state.vaultTransactions = state.vaultTransactions || [];
state.vaultCash = state.vaultCash || 0; // Ù¾ÙˆÙ„ÛŒ Ú©Ù‡ Ø¯Ø± Ø®Ø²Ø§Ù†Ù‡ Ù‡Ø³Øª Ùˆ Ø¯Ø± ØªØ±ÛŒØ¯ Ù†ÛŒØ³Øª


const toShamsiNum = (dateStr) => {
    if (!dateStr) return null;
    let shamsi;
    // Ø§Ú¯Ø± Ø§Ø² ØªÙ‚ÙˆÛŒÙ… Ø¢Ù…Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ (Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ø§ Ø®Ø· ØªÛŒØ±Ù‡)
    if (String(dateStr).includes('-')) {
        shamsi = new Date(dateStr).toLocaleDateString('fa-IR');
    } else {
        // Ø§Ú¯Ø± Ø§Ø² Ù‚Ø¨Ù„ Ø´Ù…Ø³ÛŒ Ø¨Ø§Ø´Ø¯ (Ù…Ø«Ù„ ØªØ±ÛŒØ¯Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡)
        shamsi = String(dateStr);
    }
    return parseInt(shamsi.replace(/\//g, '').replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)));
};



    const L1_ITEMS = [
        { id: 'mood', label: 'ØªØ£ÛŒÛŒØ¯ Ø­Ø§Ù„', pts: 5 },
        { id: 'fund', label: 'ØªØ£ÛŒÛŒØ¯ ÙØ§Ù†Ø¯Ø§Ù…Ù†ØªØ§Ù„', pts: 5 },
        { id: 'trend_daily', label: 'ØªØ£ÛŒÛŒØ¯ Ø±ÙˆÙ†Ø¯', pts: 5 }
    ];

    const L2_SCORING = {
        tf: [
            { id: 'd1', label: 'Daily', pts: 2.5 },
            { id: 'h4', label: '4H', pts: 3.75 },
            { id: 'h1', label: '1H', pts: 5 },
            { id: 'm30', label: '30Min', pts: 6.25 }
        ],
        trend: [
            { id: 'm15', label: '15Min', pts: 5 },
            { id: 'm5', label: '5Min', pts: 5 },
            { id: 'm1', label: '1Min', pts: 5 }
        ],
        others: [
            { id: 'macd', label: 'ÙˆØ§Ú¯Ø±Ø§ÛŒÛŒ MACD', pts: 5 },
            { id: 'slope', label: 'Ø´ÛŒØ¨ (Slope)', pts: 5 },
            { id: 'minor', label: 'Ú¯Ø±Ù‡ Ù…ÛŒÙ†ÙˆØ±', pts: 7.5 },
            { id: 'major', label: 'Ú¯Ø±Ù‡ Ù…Ø§Ú˜ÙˆØ±', pts: 10 }
        ]
    };

    window.onload = () => {
        loadData();
        L1();
        L2Checklists();
        UI();
    };

        function L1() {
        const container = document.getElementById('l1-items');
        container.innerHTML = ''; 
        
        // Ù…Ù‡Ù…: Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ÛŒ Ù„Ø§ÛŒÙ‡ Û± Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù‡Ø± Ø¨Ø§Ø± Ú©Ù‡ Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯
        L1_ITEMS.forEach(item => state.scores[item.id] = 0);
        document.getElementById('l1-total').innerText = "0";

        L1_ITEMS.forEach(item => {
            container.innerHTML += `
                <div class="check-item">
                    <span>${item.label}</span>
                    <div class="check-btns">
                        <button class="score-btn yes" onclick="setL1Score('${item.id}', ${item.pts}, this)">âœ”</button>
                        <button class="score-btn no" onclick="setL1Score('${item.id}', 0, this)">âœ–</button>
                    </div>
                </div>`;
        });
    }


    function L2Checklists() {
        document.getElementById('tf-list').innerHTML = L2_SCORING.tf.map(i => createCheckHTML(i)).join('');
        document.getElementById('trend-list').innerHTML = L2_SCORING.trend.map(i => createCheckHTML(i)).join('');
        document.getElementById('other-list').innerHTML = L2_SCORING.others.map(i => createCheckHTML(i)).join('');
    }

    function createCheckHTML(item) {
        return `<div class="check-item">
                <span>${item.label} (${item.pts})</span>
                <div class="check-btns">
                    <button class="score-btn yes" onclick="setScore('${item.id}', ${item.pts}, this)">âœ”</button>
                    <button class="score-btn no" onclick="setScore('${item.id}', 0, this)">âœ–</button>
                </div>
            </div>`;
    }

                    function setL1Score(id, pts, btn) {
                      Sound.play('click');
        const parent = btn.parentElement;
        parent.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.scores[id] = pts;

        let totalScore = 0;
        let clickedCount = 0;

        L1_ITEMS.forEach(item => {
            const row = document.querySelector(`[onclick*="setL1Score('${item.id}'"]`).parentElement;
            if (row.querySelector('.active')) {
                clickedCount++;
                totalScore += (state.scores[item.id] || 0);
            }
        });

        document.getElementById('l1-total').innerText = totalScore; 

        // Ø¨Ù‡ Ø¬Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø±ØŒ ÙÙ‚Ø· Ø§Ú¯Ø± Ù‡Ø± Û³ Ø±Ø¯ÛŒÙ Ú©Ù„ÛŒÚ© Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
        const enterBtn = document.getElementById('enter-layer2-btn');
        if(clickedCount === L1_ITEMS.length && totalScore >= 15) {
            enterBtn.style.display = 'block';
        } else {
            enterBtn.style.display = 'none';
        }
    }

    // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¯Ø³ØªÛŒ
    function goToLayer2() {
      if (Sound.ctx.state === 'suspended') Sound.ctx.resume();
        state.layer1Complete = true;
        document.getElementById('layer-2').style.display = 'block';
        document.getElementById('layer-1').style.display = 'none';
        saveData();
    }


    function setMode(m) {
        state.mode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('scoring-sections').className = (m === 'scalp' ? 'hidden' : '');
        calculateAll();
    }

        function setScore(id, pts, btn) {
          Sound.play('click');
        // Ø§ÛŒØ³Øª Ø¨Ø§Ø²Ø±Ø³ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ Ø§Ù…ØªÛŒØ§Ø²: Ø§Ú¯Ø± ÙˆÙ‚Øª ØªØ§ÛŒÛŒØ¯ Ù„Ø§ÛŒÙ‡ Û± Ø§Ø³ØªØŒ Ù†Ú¯Ø°Ø§Ø± ØªÛŒÚ© Ø¨Ø²Ù†Ø¯
        if (state.trades.length > 0 && state.trades.length % 3 === 0 && !state.layer1Complete) {
            document.getElementById('layer-2').style.display = 'none';
            document.getElementById('layer-1').style.display = 'block';
            window.scrollTo(0,0);
            return; // Ø§Ø¬Ø§Ø²Ù‡ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ ØªÛŒÚ© Ø¨Ø®ÙˆØ±Ø¯ ØªØ§ Ù„Ø§ÛŒÙ‡ Û± ØªØ§ÛŒÛŒØ¯ Ø´ÙˆØ¯
        }

        const parent = btn.parentElement;
        parent.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.scores[id] = pts;
        calculateAll();
    }


function calculateAll() {
    // Û±. Ø¯Ø±ÛŒØ§ÙØª Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ
    state.balance = parseFloat(document.getElementById('balance').value) || 0;
    state.sl = parseFloat(document.getElementById('sl-pipette').value) || 0;
    
    // Û². Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªØ±ÛŒØ¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²
    const todayStr = new Date().toLocaleDateString('fa-IR');
    const todayTrades = state.trades.filter(t => t.date === todayStr);

    // Û³. Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ ØµØ­ÛŒØ­ Ø±ÛŒØ³Ú© (Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø¨ÛŒâ€ŒÙ…ÙˆØ±Ø¯ Ø´Ø±ÙˆØ¹ Ø±ÙˆØ²)
    if (todayTrades.length > 0) {
        state.consumedRisk = todayTrades.reduce((sum, t) => {
            const rD = parseFloat(t.riskD) || 1; 
            let impact = (t.resultD < 0) ? Math.abs(t.resultD/rD)*t.riskP : (t.resultD > 0 ? -(t.resultD/rD)*t.riskP : 0);
            return sum + impact;
        }, 0);
    } else {
        // ÙÙ‚Ø· Ø§Ú¯Ø± Ù‡ÛŒÚ† ØªØ±ÛŒØ¯ÛŒ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ø¨Ù†Ø§ÛŒ Ø±ÙˆØ² Ø±ÛŒØ³Øª Ù…ÛŒØ´Ù‡
        state.dayStartBalance = state.balance;
        state.consumedRisk = 0;
    }

    const startBal = state.dayStartBalance;

    // Û´. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ù„Ø§ÛŒÙ‡ Û²
    let totalScore = 0;
    Object.keys(state.scores).forEach(key => {
        if(!L1_ITEMS.find(i => i.id === key)) totalScore += (state.scores[key] || 0);
    });
    totalScore += parseFloat(document.getElementById('pa-select').value) || 0;
    totalScore += parseFloat(document.getElementById('miner-select').value) || 0;
    
    // Ûµ. ØªØ¹ÛŒÛŒÙ† Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú© ØªØ±ÛŒØ¯ ÙØ¹Ù„ÛŒ
    let riskPercent = (state.mode === 'scalp') ? 2 : (totalScore < 70 ? 3 : (totalScore < 90 ? 4 : 5));
    
    // Û¶. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù„Ø§Øª Ùˆ Ù†Ù…Ø§ÛŒØ´
    let lotSize = (state.balance > 0 && state.sl > 0) ? (state.balance * (riskPercent / 100)) / state.sl : 0;
    document.getElementById('top-lot').innerText = lotSize.toFixed(3);
    document.getElementById('sl-dollar-display').innerText = (state.balance * (riskPercent / 100)).toFixed(2);
    
    updateFooterStyle(riskPercent, state.mode);

    // Û·. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² ÙˆØ§Ù‚Ø¹ÛŒ)
    let remainingRiskPercent = 0;
    if (state.balance > 0 && startBal > 0) {
        remainingRiskPercent = ((state.balance - (0.95 * startBal)) / state.balance) * 100;
    }

    // Û¸. Ø¢Ù¾Ø¯ÛŒØª ÙÙˆØªØ± Ø¯Ø± Ù„Ø­Ø¸Ù‡
    document.getElementById('f-rem-risk').innerText = remainingRiskPercent.toFixed(2) + "%";
    document.getElementById('f-start-bal').innerText = startBal.toFixed(2) + "$";

    // Û¹. Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÙÙ„
    const isRiskFinished = remainingRiskPercent <= 0 && todayTrades.length > 0;
    const saveBtn = document.querySelector('button[onclick="saveTrade()"]');

    if (isRiskFinished) {
        document.getElementById('f-rem-risk').style.color = "var(--neon-red)";
        if(saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerText = "â›” Ø±ÛŒØ³Ú© ØªÙ…Ø§Ù… Ø´Ø¯Ù‡";
        }
    } else {
        state.lockAlertShown = false; 
        document.getElementById('f-rem-risk').style.color = "var(--neon-green)";
        if(saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerText = "Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ù…Ø±ÙˆØ²";
        }
    }

    // Û±Û°. Ø§Ø¹ØªØ¨Ø§Ø± SL
    const slCreditEl = document.getElementById('f-sl-credit');
    if (slCreditEl) {
        slCreditEl.innerText = calculateSLCredit(state.balance, startBal, riskPercent);
    }

    saveData();
}





    function saveTrade() {
    // Ø§ÛŒØ³Øª Ø¨Ø§Ø²Ø±Ø³ÛŒ Ù„Ø§ÛŒÙ‡ Û±
    if (state.trades.length > 0 && state.trades.length % 3 === 0 && !state.layer1Complete) {
        alert("Ø§Ø¨ØªØ¯Ø§ Ù„Ø§ÛŒÙ‡ Û± Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯!");
        document.getElementById('layer-2').style.display = 'none';
        document.getElementById('layer-1').style.display = 'block';
        return;
    }

    const resVal = parseFloat(document.getElementById('trade-result').value);
    const slVal = parseFloat(document.getElementById('sl-pipette').value); 
    const noteVal = document.getElementById('trade-note').value || "---";

    if(isNaN(resVal)) return alert("Ù†ØªÛŒØ¬Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");

    // --- Ø´Ø±ÙˆØ· Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§Ù„Ø§Ù†Ø³ Ùˆ Ø­Ø¯ Ø¶Ø±Ø± ---
    if (state.balance <= 0) {
        alert("Ø¨Ø§Ù„Ø§Ù†Ø³ Ø´Ù…Ø§ ØµÙØ± ÛŒØ§ Ù…Ù†ÙÛŒ Ø§Ø³Øª!");
        return;
    }
    if (isNaN(slVal) || slVal <= 0) {
        alert("Ø¨Ø¯ÙˆÙ† ØªØ¹ÛŒÛŒÙ† Ø­Ø¯ Ø¶Ø±Ø± (SL) Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø«Ø¨Øª Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù†ÛŒØ³ØªÛŒØ¯!");
        return;
    }
// --- Ø¯Ø§Ø®Ù„ ØªØ§Ø¨Ø¹ saveTrade ---
const today = new Date().toLocaleDateString('fa-IR'); 

// Ø§Ú¯Ø± Ø§ÙˆÙ„ÛŒÙ† ØªØ±ÛŒØ¯ Ø§Ù…Ø±ÙˆØ² Ø§Ø³Øª ÛŒØ§ Ú©Ù„Ø§Ù‹ ØªØ§Ø±ÛŒØ®ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
if (state.lastTradeDate !== today) {
    state.dayStartBalance = state.balance; 
    state.lastTradeDate = today;
    state.consumedRisk = 0; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø±ÛŒØ³Ú© Ù…ØµØ±ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯
}


    
    


    // --- Û². Ù…Ø­Ø§Ø³Ø¨Ø§Øª ØªØ±ÛŒØ¯ ---
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ø§Ù…ØªÛŒØ§Ø² Ù„Ø§ÛŒÙ‡ Û² Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯Ù‚Øª Ù…Ø­Ø§Ø³Ø¨Ø§Øª
    let currentScore = 0;
    Object.keys(state.scores).forEach(key => {
        if(!L1_ITEMS.find(i => i.id === key)) currentScore += (state.scores[key] || 0);
    });
    currentScore += parseFloat(document.getElementById('pa-select').value) || 0;
    currentScore += parseFloat(document.getElementById('miner-select').value) || 0;

    // ØªØ¹ÛŒÛŒÙ† Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú© Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø®ÙˆØ¯Øª
    const riskP = (state.mode === 'scalp') ? 2 : (currentScore < 70 ? 3 : (currentScore < 90 ? 4 : 5));
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ø¯Ù„Ø§Ø±ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ (Ù…Ø¨Ù†Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ R)
    const riskD = state.balance * (riskP / 100);

        const now = new Date();
    const shamsiDate = now.toLocaleDateString('fa-IR');
    // Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ù…Øª Ø³Ø§Ø¹Øª Ùˆ Ø¯Ù‚ÛŒÙ‚Ù‡
    const timeStr = now.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });

        const trade = {
        id: now.getTime(),
        date: shamsiDate, 
        time: timeStr,
        dateValue: toShamsiNum(shamsiDate),
        timestamp: now.getTime(),
        mode: state.mode,
        riskP: riskP,
        riskD: riskD.toFixed(2), // *** Ø§ÛŒÙ† Ø®Ø· Ø¨Ø³ÛŒØ§Ø± Ø­ÛŒØ§ØªÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ú©Ø¯ Ø´Ù…Ø§ Ù†Ø¨ÙˆØ¯ ***
        slPipette: slVal,
        resultD: resVal,
        r: (riskD !== 0) ? parseFloat((resVal / riskD).toFixed(2)) : 0,
        score: currentScore,
        entryBalance: state.balance.toFixed(2),
        note: noteVal 
    };

    
        // --- Ø´Ø±ÙˆØ¹ Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù„â€ŒÙ…Ø§Ø±Ø¬ÛŒÙ† ---
    
    // Û±. Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø¹Ø« Ú©Ø§Ù„ Ù…Ø§Ø±Ø¬ÛŒÙ† Ø´Ø¯Ù‡ ÛŒØ§ Ø®ÛŒØ±
    if (resVal < 0 && Math.abs(resVal) >= state.balance) {
        // Ø­Ø³Ø§Ø¨ ØµÙØ± Ø´Ø¯
        state.balance = 0;
        state.callMarginCount = (state.callMarginCount || 0) + 1; // Ø´Ù…Ø§Ø±Ø´ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù„ Ù…Ø§Ø±Ø¬ÛŒÙ†
        
        if (typeof Sound !== 'undefined') Sound.play('error');
        
        Swal.fire({
            title: 'âŒ CALL MARGIN',
            text: `Ù…Ø¨Ù„Øº Ø¶Ø±Ø± Ø§Ø² Ú©Ù„ Ø¯Ø§Ø±Ø§ÛŒÛŒ Ù…Ø§Ø±Ø¬ÛŒÙ† Ø´Ù…Ø§ Ø¨ÛŒØ´ØªØ± Ø¨ÙˆØ¯. Ø­Ø³Ø§Ø¨ ØµÙØ± Ø´Ø¯! (ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ù„â€ŒÙ…Ø§Ø±Ø¬ÛŒÙ†â€ŒÙ‡Ø§: ${state.callMarginCount})`,
            icon: 'error',
            background: '#1a1a1a', color: '#ff3131'
        });
    } else {
        // Ø§Ú¯Ø± Ú©Ø§Ù„ Ù…Ø§Ø±Ø¬ÛŒÙ† Ù†Ø´Ø¯ØŒ Ù…Ø¨Ù„Øº Ø³ÙˆØ¯ ÛŒØ§ Ø¶Ø±Ø± Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†
        state.balance += resVal;
    }

    // Û². Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ£Ø«ÛŒØ± Ø±ÛŒØ³Ú© Ø±ÙˆÛŒ Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø±ÙˆØ²Ø§Ù†Ù‡ (Risk Consumption)
    if (!state.vault) state.vault = { transactions: [] };
    let impact = (resVal < 0) ? Math.abs(resVal/riskD)*riskP : (resVal > 0 ? -(resVal/riskD)*riskP : 0);
    state.consumedRisk += impact;
    
    // Û³. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ù‡ Ù„ÛŒØ³Øª
    state.trades.unshift(trade);
    
    // --- Ù¾Ø§ÛŒØ§Ù† Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ---

    // Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ù„Ø§ÛŒÙ‡ Û± Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø± Û³ Ù…Ø¹Ø§Ù…Ù„Ù‡
    if (state.trades.length % 3 === 0) {
        state.layer1Complete = false;
        L1_ITEMS.forEach(i => state.scores[i.id] = 0);
        document.querySelectorAll('#l1-items .score-btn').forEach(b => b.classList.remove('active'));
        const totalL1 = document.getElementById('l1-total');
        if(totalL1) totalL1.innerText = "0";
        if(document.getElementById('enter-layer2-btn')) {
            document.getElementById('enter-layer2-btn').style.display = 'none';
        }
    }
Sound.play('success');
    UI();
    document.getElementById('trade-result').value = '';
    document.getElementById('trade-note').value = ''; 
    resetScoresOnly(); // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ±Ù… Ø¨Ø±Ø§ÛŒ ØªØ±ÛŒØ¯ Ø¨Ø¹Ø¯ÛŒ

    
    saveData();
    
    // NEW: Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ø®Ø²Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø³ÙˆØ¯ Ø¯Ø± Ù„Ø­Ø¸Ù‡
    if (typeof renderVault === "function") renderVault();
}


function deleteTrade(id) {
    if(!confirm("Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ù‡ØŸ")) return;
    
    if (typeof Sound !== 'undefined') Sound.play('error');
    
    const idx = state.trades.findIndex(t => t.id === id);
    if (idx === -1) return;
    
    const t = state.trades[idx];
    
    // Û±. Ø§ØµÙ„Ø§Ø­ Ø¨Ø§Ù„Ø§Ù†Ø³ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ
    state.balance -= parseFloat(t.resultD);
    
    // Û². Ø§ØµÙ„Ø§Ø­ Ø±ÛŒØ³Ú© Ù…ØµØ±Ù Ø´Ø¯Ù‡
    const riskD = parseFloat(t.riskD);
    if (riskD !== 0) {
        let impact = (t.resultD < 0) ? Math.abs(t.resultD/riskD)*t.riskP : (t.resultD > 0 ? -(t.resultD/riskD)*t.riskP : 0);
        state.consumedRisk -= impact;
    }
    
    // Û³. Ø­Ø°Ù Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø§Ø² Ù„ÛŒØ³Øª
    state.trades.splice(idx, 1);
    state.lockAlertShown = false; 

        // Û´. Ø¢Ù¾Ø¯ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹ Ø±ÙˆØ²
    updateDynamicDayStart();


    // Ûµ. Ø¢Ù¾Ø¯ÛŒØª Ø§ÛŒÙ†Ù¾ÙˆØª Ùˆ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ§ÛŒ
    if(document.getElementById('balance')) {
        document.getElementById('balance').value = state.balance.toFixed(2);
    }
    
    saveData();
    calculateAll(); // Ø±ÛŒØ³Ú© Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø±Ùˆ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø§ØµÙ„Ø§Ø­ Ù…ÛŒâ€ŒÚ©Ù†Ù‡
    UI();
    
    if (typeof History === "function") History();
    if (typeof renderVault === "function") renderVault();
}







function History() {
    const container = document.getElementById('-history-content');
    if(!container) return;
    
    container.innerHTML = '<h3>Ø¢Ø±Ø´ÛŒÙˆ Ú©Ø§Ù…Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>';
    
    // Ø³ÙˆØ±Øª Ú©Ø±Ø¯Ù†: Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† ØªØ±ÛŒØ¯ Ø§ÙˆÙ„ Ø¨ÛŒØ§ÛŒØ¯
    const sortedTrades = [...state.trades].sort((a, b) => b.id - a.id);
    
    const groups = {};
    sortedTrades.forEach(t => {
        const date = t.date || 'Ù†Ø§Ù…Ø´Ø®Øµ';
        if (!groups[date]) groups[date] = [];
        groups[date].push(t);
    });

    Object.keys(groups).forEach(date => {
        container.innerHTML += `<div style="color:var(--neon-blue); margin: 20px 0 10px; border-bottom:1px solid #333; padding-bottom:5px;">ğŸ“… Ù…Ø¹Ø§Ù…Ù„Ø§Øª ${date}</div>`;
        
        groups[date].forEach(t => {
            container.innerHTML += `
                <div class="glass-card summary-card" style="position: relative; border-right: 5px solid ${t.resultD >= 0 ? 'var(--neon-green)' : 'var(--neon-red)'}; margin-bottom: 10px; padding: 15px; text-align:right;">
                    <div style="position: absolute; left: 10px; top: 10px; display: flex; gap: 10px;">
                        
                        <button class="delete-btn" style="float:none; background:none; border:none;" onclick="deleteTrade(${t.id})">ğŸ—‘</button>
                    </div>
                    
                    <b style="color:var(--neon-blue)">${t.mode.toUpperCase()}</b> | Ø§Ù…ØªÛŒØ§Ø²: ${t.score}<br>
                    
                    <div style="font-size: 0.75rem; color: var(--text-gray); margin: 5px 0;">
                        <span style="color:var(--neon-blue)">â° ${t.time || '--:--'}</span> | 
                        <span>Ø¨Ø§Ù„Ø§Ù†Ø³ ÙˆØ±ÙˆØ¯: ${t.entryBalance}$</span> | 
                        <span>Ø­Ø¯ Ø¶Ø±Ø±: ${t.riskD}$ <small>(${t.slPipette || 0} p)</small></span>
                    </div>
                    
                    Ù†ØªÛŒØ¬Ù‡: <span class="${t.resultD >= 0 ? 'pos-value' : 'neg-value'}" style="font-weight:bold;">${t.resultD}$ (R: ${t.r})</span>
                    
                    <div style="margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 5px;">
                        <button onclick="let n = this.nextElementSibling; n.style.display = n.style.display === 'none' ? 'block' : 'none';" 
                                style="background:none; border:none; color:var(--neon-yellow); cursor:pointer; font-size: 0.75rem; padding:0; font-family:inherit;">
                            ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª
                        </button>
                        <div style="display:none; font-size: 0.8rem; color: #bbb; margin-top: 5px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px; font-style: italic; border-right: 2px solid var(--neon-yellow);">
                            ${t.note || 'ØªÙˆØ¶ÛŒØ­Ø§ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.'}
                        </div>
                    </div>
                </div>`;
                    // --- Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ ---
    state.scores = {}; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
    
    // Ø¨Ø±Ø¯Ø§Ø´ØªÙ† ØªÛŒÚ© ØªÙ…Ø§Ù… Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Yes/No
    document.querySelectorAll('.score-btn').forEach(btn => btn.classList.remove('active'));
    
    // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø´ÙˆÛŒÛŒ (Ù¾Ø±Ø§ÛŒØ³ Ø§Ú©Ø´Ù† Ùˆ Ù…Ø§ÛŒÙ†Ø±)
    if(document.getElementById('pa-select')) document.getElementById('pa-select').value = "0";
    if(document.getElementById('miner-select')) document.getElementById('miner-select').value = "0";
    
    // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯ Ø­Ø¯ Ø¶Ø±Ø± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ø§Ú¯Ø± Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ±ÛŒØ¯ Ø¨Ø¹Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯)
    // document.getElementById('sl-pipette').value = '';

    // Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ÙÙˆØªØ± Ù‡Ù… Ø¨Ù‡ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ø®Ø§Ú©Ø³ØªØ±ÛŒ/Ø¢Ø¨ÛŒ) Ø¨Ø±Ú¯Ø±Ø¯Ø¯
    calculateAll();

        });
    
    });
}



function UI() {
    const toNum = s => parseInt(String(s).replace(/\//g, '').replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)));
    const todayVal = toNum(new Date().toLocaleDateString('fa-IR')); 
    
    let dailyProfit = 0;
    const todayTrades = state.trades.filter(t => {
        const tVal = t.dateValue || toNum(t.date);
        return tVal === todayVal;
    });

    todayTrades.forEach(t => dailyProfit += parseFloat(t.resultD));

    // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÙˆØªØ±
    document.getElementById('f-daily-pnl').innerText = dailyProfit.toFixed(2) + "$";
    document.getElementById('f-daily-pnl').style.color = dailyProfit >= 0 ? "var(--neon-green)" : "var(--neon-red)";
    document.getElementById('balance').value = state.balance.toFixed(2);
    document.getElementById('f-start-bal').innerText = state.dayStartBalance.toFixed(2) + "$";

    const container = document.getElementById('trade-history-today');
    if(container) {
        container.innerHTML = `<h4 style="color:var(--neon-blue); margin-bottom:10px;">âš¡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù…Ø±ÙˆØ²</h4>`;
        
        if(todayTrades.length === 0) {
            container.innerHTML += '<p style="color:gray; font-size:0.8rem; text-align:center;">Ù‡Ù†ÙˆØ² ØªØ±ÛŒØ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>';
        }
        
        todayTrades.forEach(t => {
            container.innerHTML += `
                <div class="glass-card summary-card" style="position: relative; border-right: 5px solid ${t.resultD >= 0 ? 'var(--neon-green)' : 'var(--neon-red)'}; margin-bottom: 10px; padding: 15px; text-align:right;">
                    <div style="position: absolute; left: 10px; top: 10px; display: flex; gap: 10px;">
                        
                        <button class="delete-btn" style="float:none; background:none; border:none; cursor:pointer;" onclick="deleteTrade(${t.id})">ğŸ—‘</button>
                    </div>
                    <b style="color:var(--neon-blue)">${t.mode.toUpperCase()}</b> | Ø§Ù…ØªÛŒØ§Ø²: ${t.score}<br>
                    <div style="font-size: 0.75rem; color: var(--text-gray); margin: 5px 0;">
                        <span>${t.date} <small style="color:var(--neon-blue)">â° ${t.time || ''}</small></span> | 
                        <span>ÙˆØ±ÙˆØ¯: ${t.entryBalance}$</span> |
                        <span style="color:var(--neon-red)">SL: ${t.riskD || 0}$ (${t.slPipette || 0}p)</span>
                    </div>
                    Ù†ØªÛŒØ¬Ù‡: <span class="${t.resultD >= 0 ? 'pos-value' : 'neg-value'}" style="font-weight:bold;">${t.resultD}$ (R: ${t.r})</span>
                    <div style="margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 5px;">
                        <button onclick="let n = this.nextElementSibling; n.style.display = n.style.display === 'none' ? 'block' : 'none';" 
                                style="background:none; border:none; color:var(--neon-yellow); cursor:pointer; font-size: 0.75rem; padding:0; font-family:inherit;">
                            ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ØªØ±ÛŒØ¯
                        </button>
                        <div style="display:none; font-size: 0.8rem; color: #bbb; margin-top: 5px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px; font-style: italic; border-right: 2px solid var(--neon-yellow);">
                            ${t.note || 'ØªÙˆØ¶ÛŒØ­Ø§ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.'}
                        </div>
                    </div>
                </div>`; 
        });
    }
    // Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø³ÛŒØ§Ø± Ø­ÛŒØ§ØªÛŒ Ø§Ø³Øª Ùˆ Ø¨Ø§ÛŒØ¯ Ø¨Ù…Ø§Ù†Ø¯
    checkBalanceLock();
}


// Û². Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù‡Ù… Ø²ÛŒØ± ØªØ§Ø¨Ø¹ Ù‚Ø¨Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†



function resetScoresOnly() {
    state.scores = {}; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ Ø§Ø² Ø­Ø§ÙØ¸Ù‡
    
    // Ø¨Ø±Ø¯Ø§Ø´ØªÙ† ØªÛŒÚ© ØªÙ…Ø§Ù… Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Yes/No Ø¯Ø± Ù„Ø§ÛŒÙ‡ Û²
    document.querySelectorAll('#scoring-sections .score-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øª Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø§ÛŒØ³ Ø§Ú©Ø´Ù† Ùˆ Ù…Ø§ÛŒÙ†Ø±
    const pa = document.getElementById('pa-select');
    const mi = document.getElementById('miner-select');
    if(pa) pa.value = "0";
    if(mi) mi.value = "0";

    // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ù¾ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡
    document.getElementById('trade-result').value = '';
    document.getElementById('trade-note').value = '';

    // Ø¢Ù¾Ø¯ÛŒØª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ ÙÙˆØªØ± (ØªØ§ Ø±ÛŒØ³Ú© Ùˆ Ø§Ù…ØªÛŒØ§Ø² ØµÙØ± Ø´ÙˆÙ†Ø¯)
    calculateAll();
}




    function saveData() { localStorage.setItem('trade_plan_state', JSON.stringify(state)); }

    function loadData() {
        const saved = localStorage.getItem('trade_plan_state');
        if(saved) {
            state = JSON.parse(saved);
            state.layer1Complete = false;
            document.getElementById('layer-1').style.display = 'block';
            document.getElementById('layer-2').style.display = 'none';
            UI();
        }
    }

        function hardReset() {
        if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;
        localStorage.removeItem('trade_plan_state');
        location.reload(); // ØµÙØ­Ù‡ Ø±Ø§ Ù…Ø«Ù„ Ø±ÙˆØ² Ø§ÙˆÙ„ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    }

function checkLayerAndCalc() {
    // Ø§ÛŒØ³Øª Ø¨Ø§Ø²Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø´ÙˆÛŒÛŒ
    if (state.trades.length > 0 && state.trades.length % 3 === 0 && !state.layer1Complete) {
        document.getElementById('layer-2').style.display = 'none';
        document.getElementById('layer-1').style.display = 'block';
        window.scrollTo(0,0);
        return;
    }
    calculateAll(); // Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
}

        
      



function updateDynamicDayStart() {
    const todayStr = new Date().toLocaleDateString('fa-IR');
    
    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù…Ø±ÙˆØ² Ùˆ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø§Ø² Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø«Ø¨Øª)
    const todayTrades = state.trades
        .filter(t => t.date === todayStr)
        .sort((a, b) => a.id - b.id); 

    if (todayTrades.length > 0) {
        // Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯: Ø¨Ø§Ù„Ø§Ù†Ø³Ù ÙˆØ±ÙˆØ¯Ù Ø§ÙˆÙ„ÛŒÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù‡Ù†ÙˆØ² Ø¯Ø± Ù„ÛŒØ³Øª Ù‡Ø³Øª
        state.dayStartBalance = parseFloat(todayTrades[0].entryBalance);
    } else {
        // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ù…Ø¹Ø§Ù…Ù„Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒ Ù†Ù…Ø§Ù†Ø¯Ù‡ØŒ Ø¨Ø§Ù„Ø§Ù†Ø³ ÙØ¹Ù„ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯
        state.dayStartBalance = state.balance;
    }
}



        
    // Û±. ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ± Ù‡ÙˆØ´Ù…Ù†Ø¯

function MainChart() {
    const canvas = document.getElementById('equityChartMain');
    if (!canvas) return;

    // Û±. Ú¯Ø±ÙØªÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÛŒÙ„ØªØ±
    const fromVal = document.getElementById('filter-from').value;
    const toVal = document.getElementById('filter-to').value;

    // Û². Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ±ÛŒØ¯Ù‡Ø§ (Ú©Ù¾ÛŒ Ùˆ Ù…Ø¹Ú©ÙˆØ³ Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ ØªØ±ØªÛŒØ¨ Ø²Ù…Ø§Ù†ÛŒ Ø§Ø² Ù‚Ø¯ÛŒÙ… Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯)
    let tradesToProcess = [...state.trades].reverse();

    // Û³. Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ± Ù‡ÙˆØ´Ù…Ù†Ø¯
    if (fromVal || toVal) {
        const fromNum = fromVal ? toShamsiNum(fromVal) : 0;
        const toNum = toVal ? toShamsiNum(toVal) : 99999999;

        tradesToProcess = tradesToProcess.filter(t => {
            const tVal = t.dateValue || toShamsiNum(t.date);
            return tVal >= fromNum && tVal <= toNum;
        });
    }

    // Û´. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø­ÛŒØ§ØªÛŒ Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø± (Ø­Ø§Ù„Ø§ ÙÙ‚Ø· ØªØ±ÛŒØ¯Ù‡Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡ Ø±Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
    updateChartStats(tradesToProcess);

    // Ûµ. Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ø§ Ù…Ù†Ø·Ù‚ Ø´Ø±ÙˆØ¹ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
    if (window.myMainChart instanceof Chart) window.myMainChart.destroy();
    
    const ctx = canvas.getContext('2d');
    
    // ØªØ¹ÛŒÛŒÙ† Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹: Ø§Ú¯Ø± ØªØ±ÛŒØ¯ÛŒ Ø¨ÙˆØ¯ØŒ Ø¨Ø§Ù„Ø§Ù†Ø³Ù ÙˆØ±ÙˆØ¯Ù Ø§ÙˆÙ„ÛŒÙ† ØªØ±ÛŒØ¯Ù ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡ Ø±Ø§ Ù…Ø¨Ù†Ø§ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡
    let startBal = tradesToProcess.length > 0 ? 
        parseFloat(tradesToProcess[0].entryBalance) : 
        (state.trades.length > 0 ? parseFloat(state.trades[state.trades.length-1].entryBalance) : state.balance);
    
    let chartData = [startBal];
    let labels = ["Ø´Ø±ÙˆØ¹"];
    let currentTotal = startBal;

    tradesToProcess.forEach((t, i) => {
        currentTotal += parseFloat(t.resultD);
        chartData.push(currentTotal);
        // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ ØªØ±ÛŒØ¯ Ø¯Ø± Ù…Ø­ÙˆØ± Ø§ÙÙ‚ÛŒ
        labels.push(t.date ? t.date.split('/').slice(1).join('/') : `T${i + 1}`); 
    });

    window.myMainChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ø±Ø´Ø¯ Ø­Ø³Ø§Ø¨',
                data: chartData,
                borderColor: '#00d2ff',
                backgroundColor: 'rgba(0, 210, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
                pointRadius: (context) => (context.dataIndex === 0 ? 4 : 5),
                pointBackgroundColor: (context) => {
                    const idx = context.dataIndex;
                    if (idx === 0) return '#fff';
                    return chartData[idx] >= chartData[idx-1] ? '#39ff14' : '#ff3131';
                },
                pointBorderColor: '#0a0a0c',
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    rtl: true,
                    callbacks: {
                        label: (context) => ` Ø¨Ø§Ù„Ø§Ù†Ø³: ${context.raw.toFixed(2)}$`
                    }
                }
            },
            scales: {
                y: { 
                    grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false }, 
                    ticks: { color: '#a0a0a0', font: { size: 10 } } 
                },
                x: { 
                    grid: { display: false }, 
                    ticks: { color: '#888', font: { size: 9 }, maxRotation: 45 } 
                }
            }
        }
    });
}


// Û². ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ø¯Ø± Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ù†Ø¦ÙˆÙ†ÛŒ

function updateChartStats(trades) {
    const statsContainer = document.getElementById('chart-stats');
    if (!statsContainer) return;

    // Û±. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† total Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯ÛŒØªØ§
    const m = {
        total: { pnl: 0, wins: 0, count: 0, rSum: 0, totalRisk: 0, grossWin: 0, grossLoss: 0 },
        trend: { pnl: 0, wins: 0, count: 0, rSum: 0, totalRisk: 0, grossWin: 0, grossLoss: 0 },
        range: { pnl: 0, wins: 0, count: 0, rSum: 0, totalRisk: 0, grossWin: 0, grossLoss: 0 },
        scalp: { pnl: 0, wins: 0, count: 0, rSum: 0, totalRisk: 0, grossWin: 0, grossLoss: 0 }
    };

    // Û². Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÙ…Ø§Ù… ØªØ±ÛŒØ¯Ù‡Ø§ (Ù‡Ø± ØªØ±ÛŒØ¯ Ù‡Ù… Ø¯Ø± Ù…ÙˆØ¯ Ø®ÙˆØ¯Ø´ Ùˆ Ù‡Ù… Ø¯Ø± total Ø¬Ù…Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
    trades.forEach(t => {
        const modes = [t.mode, 'total']; 
        modes.forEach(mode => {
            if (m[mode]) {
                const res = parseFloat(t.resultD) || 0;
                const risk = parseFloat(t.riskD) || 0;
                const rVal = parseFloat(t.r) || 0;

                m[mode].pnl += res;
                m[mode].count += 1;
                m[mode].rSum += rVal;
                m[mode].totalRisk += risk;

                if (res > 0) {
                    m[mode].wins += 1;
                    m[mode].grossWin += res;
                } else if (res < 0) {
                    m[mode].grossLoss += Math.abs(res);
                }
            }
        });
    });

    // Û³. ØªØ§Ø¨Ø¹ Ø¯Ø§Ø®Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¯Ø± Ù…Ù†Ø·Ù‚ Ø´Ù…Ø§)
    const createBox = (title, data, color, fullWidth = false) => {
        const winRate = data.count === 0 ? 0 : ((data.wins / data.count) * 100).toFixed(0);
        const avgR = data.count === 0 ? 0 : (data.rSum / data.count).toFixed(1);
        const pf = data.grossLoss === 0 ? data.grossWin.toFixed(1) : (data.grossWin / data.grossLoss).toFixed(2);
        const eff = data.totalRisk === 0 ? 0 : ((data.pnl / data.totalRisk) * 100).toFixed(0);

        // Ø§Ú¯Ø± fullWidth Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§Ú©Ø³ Ú©Ù„ Ø¹Ø±Ø¶ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
        const gridStyle = fullWidth ? `grid-column: 1 / -1;` : '';

        return `
            <div class="glass-card" style="${gridStyle} padding:10px; border-bottom: 2px solid ${color}; background:rgba(255,255,255,0.02); margin:0; display:flex; flex-direction:column; justify-content:space-between;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="color:${color}; font-size:0.7rem; font-weight:bold;">${title}</span>
                    <span style="font-size:0.6rem; color:#fff; opacity:0.5;">Eff: ${eff}%</span>
                </div>
                <div style="font-size:1.2rem; font-weight:bold; color:${data.pnl >= 0 ? 'var(--neon-green)' : 'var(--neon-red)'}">
                    $${data.pnl.toFixed(1)}
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:4px; margin-top:8px; font-size:0.55rem; color:#aaa; border-top:1px solid rgba(255,255,255,0.05); padding-top:5px;">
                    <span>Win: <b style="color:#fff">${winRate}%</b></span>
                    <span>PF: <b style="color:#fff">${pf}</b></span>
                    <span>Avg R: <b style="color:#fff">${avgR}</b></span>
                    <span>ØªØ¹Ø¯Ø§Ø¯: <b style="color:#fff">${data.count}</b></span>
                </div>
            </div>
        `;
    };

    // ØªÙ†Ø¸ÛŒÙ… Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ù†ØªÛŒÙ†Ø±
    statsContainer.style.display = 'grid';
    statsContainer.style.gridTemplateColumns = '1fr 1fr 1fr'; 
    statsContainer.style.gap = '8px';
    statsContainer.style.width = "100%";
    statsContainer.style.marginBottom = "15px";

    // Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ: Ø§ÙˆÙ„ Ø¨Ø§Ú©Ø³ Ú©Ù„ (Total) Ùˆ Ø¨Ø¹Ø¯ Ø³Ù‡ Ø¨Ø§Ø²Ø§Ø± Ù¾Ø§ÛŒÛŒÙ†Ø´
    statsContainer.innerHTML = 
        createBox('ğŸ’ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª', m.total, '#fff', true) + // Ø¨Ø§Ú©Ø³ Ú©Ù„ Ø¹Ø±Ø¶ Ú©Ø§Ù…Ù„
        createBox('ğŸ“ˆ TREND', m.trend, 'var(--neon-green)') +
        createBox('â†”ï¸ RANGE', m.range, 'var(--neon-blue)') +
        createBox('âš¡ SCALP', m.scalp, 'var(--neon-yellow)');
}


// Û³. ØªØ§Ø¨Ø¹ Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ± (Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø± Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª)
function resetChartFilter() {
    document.getElementById('filter-from').value = '';
    document.getElementById('filter-to').value = '';
    MainChart();
}



                // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØµÙØ­Ø§Øª (ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÛŒØ§ Ù†Ù…ÙˆØ¯Ø§Ø±)
function openPage(pageId) {
    // Û±. Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØµÙØ­Ø§Øª Ø¬Ø§Ù†Ø¨ÛŒ (Ù‡Ø± Ø³Ù‡ ØµÙØ­Ù‡ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÛŒØ³Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)
    document.getElementById('history-page').classList.add('page-hidden');
    document.getElementById('chart-page').classList.add('page-hidden');
    document.getElementById('vault-page').classList.add('page-hidden'); // Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ ØªØ§ Ø®Ø²Ø§Ù†Ù‡ Ù‡Ù… Ù…Ø®ÙÛŒ Ø´ÙˆØ¯
    
    // Û². Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ú©Ø§Ø±Ø¨Ø±
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.remove('page-hidden');
    }
    
    // Û³. Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ø±
    document.getElementById('menu-icon-container').style.display = 'none'; // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ù…Ø¨Ø±Ú¯Ø± Ù…Ù†Ùˆ
    document.getElementById('back-icon').style.display = 'flex'; // Ø¸Ø§Ù‡Ø± Ú©Ø±Ø¯Ù† ÙÙ„Ø´ Ù‚Ø±Ù…Ø² (Ø¨Ø±Ú¯Ø´Øª)
    
    // Û´. Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ø§ØªÛŒ Ù…Ø®ØµÙˆØµ Ù‡Ø± ØµÙØ­Ù‡
    if(pageId === 'history-page') History();
    if(pageId === 'chart-page') MainChart();
    if(pageId === 'vault-page') renderVault();

    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡
    window.scrollTo(0,0);
}


// ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…ÛŒØ² ØªØ±ÛŒØ¯

function closeAllPages() {
    // Û±. Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØµÙØ­Ø§Øª Ø¬Ø§Ù†Ø¨ÛŒ
    document.getElementById('history-page').classList.add('page-hidden');
    document.getElementById('chart-page').classList.add('page-hidden');
    document.getElementById('vault-page').classList.add('page-hidden');
    
    // Û². Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ø± Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ
    document.getElementById('menu-icon-container').style.display = 'flex';
    document.getElementById('back-icon').style.display = 'none';

    // Û³. Ø¨Ø³ØªÙ† ØªÙ…Ø§Ù… Ù¾Ù†Ø¬Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ù SweetAlert (Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù…)
    if (typeof Swal !== 'undefined') {
        Swal.close();
    }
}








function toggleMenu() {
    const menu = document.getElementById('side-menu');
    const overlay = document.getElementById('menu-overlay');
    if (menu.style.left === '0px') {
        menu.style.left = '-280px';
        overlay.style.display = 'none';
    } else {
        // Ø¢Ù¾Ø¯ÛŒØª Ù†ÙˆØ§Ø± Ø­Ø§ÙØ¸Ù‡ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø² Ø´Ø¯Ù† Ù…Ù†Ùˆ
        let used = JSON.stringify(localStorage).length;
        let total = 5 * 1024 * 1024; // 5MB
        let percent = ((used / total) * 100).toFixed(2);
        
        const bar = document.getElementById('storage-bar');
        const text = document.getElementById('storage-percent');
        
        if(bar && text) {
            bar.style.width = percent + "%";
            text.innerText = percent + "%";
            if (percent > 80) bar.style.background = 'var(--neon-red)';
        }

        menu.style.left = '0px';
        overlay.style.display = 'block';
    }
}


function checkBackupReminder() {
    const lastBackupDateStr = localStorage.getItem('lastBackupDate');
    const now = new Date();
    
    // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ú©Ù„ÛŒØ¯ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø±Ø§ÛŒ "Ø§Ù…Ø±ÙˆØ²" (Ù…Ø«Ù„Ø§: "2026-02-13")
    const todayKey = now.toISOString().slice(0, 10);
    
    // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ®ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
    if (lastBackupDateStr) {
        const lastBackupDate = new Date(parseInt(lastBackupDateStr)).toISOString().slice(0, 10);
        
        // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø¢Ø®Ø±ÛŒÙ† Ø¨Ú©Ø§Ù¾ Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² ÛŒÚ©ÛŒ Ù†ÛŒØ³Øª (ÛŒØ¹Ù†ÛŒ Ø§ÙˆÙ„ÛŒÙ† ÙˆØ±ÙˆØ¯Ù Ø§Ù…Ø±ÙˆØ² Ø§Ø³Øª)
        if (lastBackupDate !== todayKey) {
            showBackupAlert(now.getTime());
        }
    } else {
        // Ø§Ú¯Ø± Ú©Ù„Ø§Ù‹ ØªØ§ Ø¨Ù‡ Ø­Ø§Ù„ Ø¨Ú©Ø§Ù¾ Ù†Ú¯Ø±ÙØªÙ‡ Ø¨Ø§Ø´Ø¯
        showBackupAlert(now.getTime());
    }
}

function showBackupAlert(currentTime) {
    Swal.fire({
        title: 'Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ ğŸ›¡ï¸',
        text: 'Ø³Ù„Ø§Ù…! Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù…Ø±ÙˆØ²ØŒ Ù‡Ù…ÛŒÙ† Ø§ÙˆÙ„ Ú©Ø§Ø± ÛŒÚ© Ø®Ø±ÙˆØ¬ÛŒ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§ØªØª Ø¨Ú¯ÛŒØ±.',
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Ø§Ù„Ø§Ù† Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù…',
        cancelButtonText: 'Ø¨Ø¹Ø¯Ø§Ù‹',
        background: '#1a1a1a', 
        color: '#fff',
        confirmButtonColor: '#39ff14'
    }).then((result) => {
        if (result.isConfirmed) {
            exportBackup(); // Ù‡Ù…Ø§Ù† ØªØ§Ø¨Ø¹ Ú©Ù¾ÛŒ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
            localStorage.setItem('lastBackupDate', currentTime); 
        }
    });
}

// Ø§Ø¬Ø±Ø§ Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ† Ù„ÙˆØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡
window.addEventListener('load', checkBackupReminder);


 
 function exportBackup() {
    try {
        // ØªØ¨Ø¯ÛŒÙ„ Ú©Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ Ù…ØªÙ†
        const dataStr = JSON.stringify(state);
        
        // Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ú¯ÙˆØ´ÛŒ (Clipboard)
        navigator.clipboard.writeText(dataStr).then(() => {
            Swal.fire({
                title: 'Ú©Ù¾ÛŒ Ø´Ø¯!',
                text: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ú¯ÙˆØ´ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯. Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø¢Ù† Ø±Ø§ Ø¯Ø± ÛŒÚ© Ù¾ÛŒØ§Ù… Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… ÛŒØ§ ÛŒÚ© ÙØ§ÛŒÙ„ Ù†ÙˆØªØŒ Paste Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.',
                icon: 'success',
                background: '#1a1a1a', color: '#fff'
            });
        }).catch(err => {
            // Ø§Ú¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ú©Ù¾ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù†Ø¯Ø§Ø¯ØŒ Ù…ØªÙ† Ø±Ø§ Ø¯Ø± ÛŒÚ© Ø¨Ø§Ú©Ø³ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø®ÙˆØ¯Ø´ Ú©Ù¾ÛŒ Ú©Ù†Ø¯
            Swal.fire({
                title: 'Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±',
                input: 'textarea',
                inputValue: dataStr,
                text: 'Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… Ù…ØªÙ† Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ú©Ù¾ÛŒ (Copy) Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± Ø¬Ø§ÛŒÛŒ Ù…Ø·Ù…Ø¦Ù† Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯.',
                background: '#1a1a1a', color: '#fff'
            });
        });
    } catch (e) {
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª: " + e.message);
    }
}


 
 
 
 async function importBackup() {
    const { value: text } = await Swal.fire({
        title: 'ÙˆØ±ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Import)',
        input: 'textarea',
        inputPlaceholder: 'Ú©Ù„ Ú©Ø¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ú©Ù¾ÛŒ Ùˆ Ù¾ÙÛŒØ³Øª Ú©Ù†ÛŒØ¯...',
        inputAttributes: { 'aria-label': 'Ú©Ø¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†' },
        showCancelButton: true,
        confirmButtonText: 'ØªØ§ÛŒÛŒØ¯ Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ',
        background: '#1a1a1a', 
        color: '#fff'
    });

    if (text) {
        try {
            const importedState = JSON.parse(text);
            
            // Ú†Ú© Ú©Ø±Ø¯Ù† Ø³Ø§Ø®ØªØ§Ø± Ø§ØµÙ„ÛŒ Ø¯ÛŒØªØ§
            if (importedState && importedState.trades) {
                
                // --- Ø¨Ø®Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§Ø²ÛŒ (Sync) ---
                // Ù‡Ø± ØªØ±ÛŒØ¯ Ø±Ø§ Ú†Ú© Ù…ÛŒÚ©Ù†Ø¯ Ú©Ù‡ Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯ÛŒ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ú¯ÛŒØ±Ø¯ ØªØ§ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø®Ø±Ø§Ø¨ Ù†Ø´ÙˆØ¯
                importedState.trades = importedState.trades.map(t => ({
                    ...t,
                    time: t.time || '--:--', // Ø§Ú¯Ø± Ø³Ø§Ø¹Øª Ù†Ø¯Ø§Ø´Øª
                    riskD: t.riskD !== undefined ? parseFloat(t.riskD) : 0, // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø±ÛŒØ³Ú© Ø¯Ù„Ø§Ø±ÛŒ Ù†Ø¯Ø§Ø´Øª
                    resultD: parseFloat(t.resultD) || 0,
                    r: parseFloat(t.r) || 0,
                    mode: t.mode || 'range' // Ø§Ú¯Ø± Ù†ÙˆØ¹ Ø¨Ø§Ø²Ø§Ø± Ù…Ø´Ø®Øµ Ù†Ø¨ÙˆØ¯
                }));

                // Ø§Ø¹Ù…Ø§Ù„ Ø¯ÛŒØªØ§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡
                state = importedState;
                saveData(); // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± LocalStorage
                
                Swal.fire({
                    title: 'Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² âœ…',
                    text: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø¬Ø¯ÛŒØ¯ Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø´Ø¯.',
                    icon: 'success',
                    background: '#1a1a1a', 
                    color: '#fff'
                }).then(() => {
                    location.reload(); // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ú¯Ø±Ø§Ùâ€ŒÙ‡Ø§
                });

            } else {
                throw new Error("Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
            }
        } catch (e) {
            Swal.fire({
                title: 'Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¯ÛŒØªØ§',
                text: 'ÙØ±Ù…Øª Ú©Ø¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª ÛŒØ§ Ø¯ÛŒØªØ§ Ø¢Ø³ÛŒØ¨ Ø¯ÛŒØ¯Ù‡.',
                icon: 'error',
                background: '#1a1a1a', 
                color: '#fff'
            });
        }
    }
}


  
  function vaultTransaction(type) {
    document.activeElement.blur();
    const title = type === 'deposit' ? 'ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ø®Ø²Ø§Ù†Ù‡' : 'Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø®Ø²Ø§Ù†Ù‡';
    const color = type === 'deposit' ? '#39ff14' : '#ff3131';

    Swal.fire({
        title: title,
        target: document.getElementById('vault-page'), 
        html: `<input type="number" id="v-amount" class="swal2-input" placeholder="Ù…Ø¨Ù„Øº Ø¯Ù„Ø§Ø±ÛŒ" style="background:#222; color:white; border-color:${color}">
               <input type="text" id="v-note" class="swal2-input" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª (Ù…Ø«Ù„Ø§Ù‹: ÙˆØ§Ø±ÛŒØ² Ø³ÙˆØ¯ Ù‡ÙØªÙ‡)" style="background:#222; color:white;">`,
        showCancelButton: true,
        confirmButtonText: 'Ø«Ø¨Øª Ø¯Ø± Ø®Ø²Ø§Ù†Ù‡',
        background: '#1a1a1a', color: '#fff',
                preConfirm: () => {
            const amount = parseFloat(document.getElementById('v-amount').value);
            const note = document.getElementById('v-note').value;
            
            if (!amount || amount <= 0) return Swal.showValidationMessage('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');

            // --- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ú†Ú© Ú©Ø±Ø¯Ù† Ø³Ù‚Ù Ø¨Ø±Ø¯Ø§Ø´Øª ÙÛŒØ²ÛŒÚ©ÛŒ ---
            if (type === 'withdraw') {
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ Ù¾ÙˆÙ„ÛŒ Ú©Ù‡ ÙˆØ§Ù‚Ø¹Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø®Ø²Ø§Ù†Ù‡ Ø´Ø¯Ù‡ (ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ Ù…Ù†Ù‡Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§)
                const totalIn = state.vault.transactions
                    .filter(t => t.type === 'deposit')
                    .reduce((s, t) => s + parseFloat(t.amount || 0), 0);
                const totalOut = state.vault.transactions
                    .filter(t => t.type === 'withdraw')
                    .reduce((s, t) => s + parseFloat(t.amount || 0), 0);
                
                const physicalVaultBalance = totalIn - totalOut;

                if (amount > physicalVaultBalance + 0.01) {
                    return Swal.showValidationMessage(`âŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ù‚Ø¯ Ø®Ø²Ø§Ù†Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª! Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø±Ø¯Ø§Ø´Øª: $${physicalVaultBalance.toFixed(2)}`);
                }
            }
            return { amount, note };
        }
    }).then((res) => {
        if (res.isConfirmed) {
            if (!state.vault) state.vault = { transactions: [] };

            const now = new Date();
            const trans = {
                id: now.getTime(),
                type: type,
                amount: res.value.amount,
                note: res.value.note,
                date: now.toLocaleDateString('fa-IR'),
                time: now.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }),
                dateValue: toShamsiNum(now)
            };

            state.vault.transactions.unshift(trans);
            
            // ÛŒÚ© Ú¯Ø§Ø±Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª Ù…Ù†ÙÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ø´ÙˆØ¯
            saveData();
            renderVault();
            
            Swal.fire({
                icon: 'success',
                title: 'Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯',
                timer: 1000,
                showConfirmButton: false,
                background: '#1a1a1a', color: '#fff'
            });
        }
    });
}


// --- Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ùˆ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ù¾ÙˆÙ„ Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ø§ Ø³ÛŒØ³ØªÙ… Ø®Ø²Ø§Ù†Ù‡ ---

function transferFlow(direction, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    // Ø¨Ø³ØªÙ† Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
    document.activeElement.blur(); 

    const isToMargin = direction === 'toMargin';
    const title = isToMargin ? 'Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Margin âš¡' : 'Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Margin ğŸ¦';
    const color = isToMargin ? '#00d2ff' : '#39ff14'; // Ø¢Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø§Ø±Ø¬ÛŒÙ†ØŒ Ø³Ø¨Ø² Ø¨Ø±Ø§ÛŒ Ø®Ø²Ø§Ù†Ù‡
    
    // ØªØ¹ÛŒÛŒÙ† Ø³Ù‚Ù Ù…Ø¬Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„
    const maxAmount = isToMargin ? (state.vaultCash || 0) : state.balance;

    Swal.fire({
        title: title,
        target: document.getElementById('vault-page'), 
        html: `
            <div style="text-align:center; color:var(--text-gray); font-size:0.85rem; margin-bottom:15px;">
                Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø§Ø¨Ù„ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ: <b style="color:white;">$${maxAmount.toFixed(2)}</b>
            </div>
            <input type="number" id="v-transfer-amount" class="swal2-input" 
                   placeholder="Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" 
                   style="background:#222; color:white; border:1px solid ${color}; width:80%; text-align:center; margin:10px auto; display:block;"
                   inputmode="decimal">
            <p style="font-size:0.7rem; color:gray; margin-top:5px;">
                ${isToMargin ? 'Ù…Ø¨Ù„Øº Ø§Ø² Ú¯Ø§ÙˆØµÙ†Ø¯ÙˆÙ‚ Ú©Ø³Ø± Ùˆ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ ØªØ±ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.' : 'Ù…Ø¨Ù„Øº Ø§Ø² Ø­Ø³Ø§Ø¨ ØªØ±ÛŒØ¯ Ú©Ø³Ø± Ùˆ Ø¨Ù‡ Ú¯Ø§ÙˆØµÙ†Ø¯ÙˆÙ‚ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.'}
            </p>
        `,
        background: '#1a1a1a',
        color: '#fff',
        showCancelButton: true,
        confirmButtonText: 'Ø«Ø¨Øª Ø§Ù†ØªÙ‚Ø§Ù„',
        cancelButtonText: 'Ø§Ù†ØµØ±Ø§Ù',
        confirmButtonColor: color,
        preConfirm: () => {
            const val = document.getElementById('v-transfer-amount').value;
            const amount = parseFloat(val);
            
            if (!val || amount <= 0) {
                return Swal.showValidationMessage('Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            }
            if (amount > maxAmount + 0.01) {
                return Swal.showValidationMessage(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª! (Ø­Ø¯Ø§Ú©Ø«Ø± $${maxAmount.toFixed(2)})`);
            }
            return amount;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const amount = result.value;
            
            // Ø§Ø¬Ø±Ø§ÛŒ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ
            if (isToMargin) {
                state.balance += amount;
            } else {
                state.balance -= amount;
            }

            // Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ
            saveData();
            UI(); 
            calculateAll(); 
            renderVault(); 

            if (typeof Sound !== 'undefined') Sound.play('success');

            // ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø´Ø±ÙˆØ¹ Ø±ÙˆØ²
            Swal.fire({
                title: 'Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…',
                text: "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…Ø¨Ù†Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² (Day Start) Ø¨Ù‡ Ø¨Ø§Ù„Ø§Ù†Ø³ Ø¬Ø¯ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŸ",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø±ÛŒØ³Øª Ø´ÙˆØ¯',
                cancelButtonText: 'Ø®ÛŒØ±ØŒ ÙØ¹Ù„Ø§Ù‹ Ù†Ù‡',
                background: '#1a1a1a', 
                color: '#fff'
            }).then((res) => {
                if (res.isConfirmed) {
                    state.dayStartBalance = state.balance;
                    state.consumedRisk = 0; 
                    saveData();
                    UI();
                    renderVault();
                }
            });
        }
    });
}




function renderVault() {
    // Û±. Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§
    if (!state.vault) state.vault = { transactions: [] };
    
    // Û². Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§Ø±ÛŒØ²/Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ø³ØªÙ‚ÛŒÙ… (Ù¾ÙˆÙ„ ÙÛŒØ²ÛŒÚ©ÛŒ Ú©Ù‡ ÙˆØ§Ø±Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´Ø¯Ù‡)
    const totalExternalDep = state.vault.transactions
        .filter(t => t.type === 'deposit')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
        
    const totalExternalWit = state.vault.transactions
        .filter(t => t.type === 'withdraw')
        .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

    // Û³. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø¶Ø±Ø± Ú©Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø«Ø¨Øª Ø´Ø¯Ù‡
    const totalTradesProfit = state.trades.reduce((sum, t) => sum + (parseFloat(t.resultD) || 0), 0);

    // Û´. Ø¯Ø§Ø±Ø§ÛŒÛŒ Ú©Ù„ = (ÙˆØ§Ø±ÛŒØ² - Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ø³ØªÙ‚ÛŒÙ…) + Ø³ÙˆØ¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    const totalAsset = (totalExternalDep - totalExternalWit) + totalTradesProfit;

    // Ûµ. Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙ†Ø¯ÙˆÙ‚ = Ø¯Ø§Ø±Ø§ÛŒÛŒ Ú©Ù„ - Ø¢Ù†Ú†Ù‡ Ø¯Ø± Ù…Ø§Ø±Ø¬ÛŒÙ† Ø§Ø³Øª
    // Ù†Ú©ØªÙ‡: state.balance Ù‡Ù…Ø§Ù† Ø¹Ø¯Ø¯ In Margin Ø§Ø³Øª
    state.vaultCash = totalAsset - state.balance;

    // Û¶. Ø¢Ù¾Ø¯ÛŒØª Ù†Ù…Ø§ÛŒØ´Ú¯Ø±Ù‡Ø§
    document.getElementById('v-total-asset').innerText = `$${totalAsset.toFixed(2)}`;
    document.getElementById('v-safe-vault').innerText = `$${state.vaultCash.toFixed(2)}`;
    document.getElementById('v-in-margin').innerText = `$${state.balance.toFixed(2)}`;
    document.getElementById('v-day-start').innerText = `$${state.dayStartBalance.toFixed(2)}`;

    // Û·. Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…
    const list = document.getElementById('vault-history-list');
    list.innerHTML = '<h4 style="color:var(--neon-blue); margin: 15px 0;">ğŸ“œ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø®Ø²Ø§Ù†Ù‡</h4>';
    state.vault.transactions.forEach(t => {
        list.innerHTML += `
            <div class="glass-card" style="padding:10px; border-right: 4px solid ${t.type==='deposit'?'var(--neon-green)':'var(--neon-red)'}; margin-bottom:8px; background: rgba(255,255,255,0.02); font-size:0.8rem;">
                <div style="display:flex; justify-content:space-between;">
                    <span>${t.type==='deposit'?'â• ÙˆØ§Ø±ÛŒØ²':'â– Ø¨Ø±Ø¯Ø§Ø´Øª'} $${t.amount}</span>
                    <small style="color:#666;">${t.date}</small>
                </div>
            </div>`;
    });
}


// Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ù¾ÙˆØª Ø¨Ø§Ù„Ø§Ù†Ø³ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ ØªØ±ÛŒØ¯
function checkBalanceLock() {
    const balInput = document.getElementById('balance');
    if (!balInput) return;

    // Ù‚ÙÙ„ Ù‡Ù…ÛŒØ´Ú¯ÛŒ: ØªØ­Øª Ù‡ÛŒÚ† Ø´Ø±Ø§ÛŒØ·ÛŒ Ø§Ø¬Ø§Ø²Ù‡ ØªØ§ÛŒÙ¾ Ø¯Ø³ØªÛŒ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
    balInput.readOnly = true; 
    
    // Ø§Ø³ØªØ§ÛŒÙ„ Ø¸Ø§Ù‡Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…ØªÙˆØ¬Ù‡ Ø´ÙˆØ¯ Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ÛŒ Ø§Ø³Øª
    balInput.style.opacity = "0.8";
    balInput.style.cursor = "not-allowed";
    balInput.style.background = "rgba(255, 255, 255, 0.03)";
    balInput.style.border = "1px solid rgba(0, 210, 255, 0.2)";
    
    // Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†Ú¯Ø§Ù… Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ù…ÙˆØ³ ÛŒØ§ Ù„Ù…Ø³
    balInput.title = "ØªØºÛŒÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙÙ‚Ø· Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù…Ù†ÙˆÛŒ Ø®Ø²Ø§Ù†Ù‡ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ø§Ø³Øª";
    
    // ÛŒÚ© Ù„Ø§ÛŒÙ‡ Ø§Ù…Ù†ÛŒØªÛŒ Ø§Ø¶Ø§ÙÛŒ: Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø³Ø¹ÛŒ Ú©Ø±Ø¯ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ú©Ø±Ø¯Ù† ÙÙˆÚ©ÙˆØ³ Ú©Ù†Ø¯ØŒ ÙÙˆÚ©ÙˆØ³ Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ Ø´ÙˆØ¯
    balInput.onfocus = () => balInput.blur();
}




function exportToExcel() {
    if (state.trades.length === 0) return Swal.fire('Ø®Ø§Ù„ÛŒ', 'ØªØ±ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');

    try {
        // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Tab Ø¨Ù‡ Ø¬Ø§ÛŒ Ú©Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ ØªÙÚ©ÛŒÚ© Ø®ÙˆØ¯Ú©Ø§Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
        let csvContent = ""; 
        
        // Ø³Ø±ØªÛŒØªØ±Ù‡Ø§ (Headers) Ø¯Ù‚ÛŒÙ‚Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ù†ÛŒØ§Ø² Ø´Ù…Ø§
        const headers = ["ØªØ§Ø±ÛŒØ®", "Ø²Ù…Ø§Ù†", "Ù†ÙˆØ¹ Ø¨Ø§Ø²Ø§Ø±", "Ø§Ù…ØªÛŒØ§Ø²", "Ø¨Ø§Ù„Ø§Ù†Ø³ ÙˆØ±ÙˆØ¯", "Ø±ÛŒØ³Ú©(USD)", "Ø³ÙˆØ¯-Ø¶Ø±Ø±(USD)", "R Ú©Ø³Ø¨ Ø´Ø¯Ù‡", "ÛŒØ§Ø¯Ø¯Ø§Ø´Øª"];
        csvContent += headers.join("\t") + "\n";

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ±ÛŒØ¯Ù‡Ø§ Ø§Ø² Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯
        [...state.trades].reverse().forEach(t => {
            const row = [
                t.date,
                t.time || '',
                t.mode,
                t.score,
                t.entryBalance,
                t.riskD,
                t.resultD,
                t.r,
                (t.note || '').replace(/\t/g, ' ') // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØªØ¨â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¯Ø± ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ù… Ù†Ø®ÙˆØ±Ø¯Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
            ].join("\t");
            csvContent += row + "\n";
        });

        // Ú©Ù¾ÛŒ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…ÙˆÙ‚Øª (Clipboard)
        navigator.clipboard.writeText(csvContent).then(() => {
            Swal.fire({
                title: 'Ø¢Ù…Ø§Ø¯Ù‡ Ù¾ÙÛŒØ³Øª (Paste) âœ…',
                text: 'Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ ÙØ±Ù…Øª Ø³ØªÙˆÙ†ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯. Ø­Ø§Ù„Ø§ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª Ø¨Ø²Ù†ÛŒØ¯ Ø±ÙˆÛŒ Ø³Ù„ÙˆÙ„ A1 Ùˆ Paste Ú©Ù†ÛŒØ¯.',
                icon: 'success',
                background: '#1a1a1a', 
                color: '#fff'
            });
        }).catch(err => {
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø¨Ø§Ú©Ø³ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ Ø¯Ø³ØªÛŒ Ø§Ú¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯
            Swal.fire({
                title: 'Ú©Ù¾ÛŒ Ø¯Ø³ØªÛŒ',
                input: 'textarea',
                inputValue: csvContent,
                text: 'Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ú©Ù¾ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù†Ø¯Ø§Ø¯. Ù…ØªÙ† Ø¨Ø§Ù„Ø§ Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª Ù¾ÙÛŒØ³Øª Ú©Ù†ÛŒØ¯.',
                background: '#1a1a1a', color: '#fff'
            });
        });
    } catch (e) {
        Swal.fire('Ø®Ø·Ø§', 'Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ù¾ÛŒØ´ Ø¢Ù…Ø¯: ' + e.message, 'error');
    }
}



function calculateSLCredit(currentBal, startBal, riskPercent) {
    // Û±. Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† ØªØ±ÛŒØ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø¹ØªØ¨Ø§Ø± Ù‡Ù…ÛŒØ´Ù‡ ØµÙØ± Ø¨Ø§Ø´Ø¯ (Ø­ØªÛŒ Ø§Ú¯Ø± Ù¾ÙˆÙ„ ÙˆØ§Ø±ÛŒØ² Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
    if (!state.trades || state.trades.length === 0) return "0";

    // Û². Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ Ø§Ø² Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² Ú©Ù…ØªØ± Ø¨Ø§Ø´Ø¯ (Ø¯Ø± Ø¶Ø±Ø± Ø¨Ø§Ø´ÛŒÙ…) ÛŒØ§ Ø±ÛŒØ³Ú© ØµÙØ± Ø¨Ø§Ø´Ø¯
    if (currentBal <= startBal || riskPercent <= 0) return "0";

    try {
        let ratio = startBal / currentBal;
        let riskFactor = 1 - (riskPercent / 100);
        
        // Û³. Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ±Ù…ÙˆÙ„ Ù„Ú¯Ø§Ø±ÛŒØªÙ…ÛŒ
        let credit = Math.log(ratio) / Math.log(riskFactor);
        
        // Û´. Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¹Ø¯Ø¯ Ø¨Ø¯ÙˆÙ† Ø³Ù‚Ù (ÙÙ‚Ø· Ø¨Ø§ ÛŒÚ© Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ Ø¸Ø§Ù‡Ø±)
        return credit.toFixed(1);
    } catch (e) {
        return "0";
    }
}


function updateFooterStyle(riskP, mode) {
    const footerEl = document.getElementById('sticky-bar');
    if (!footerEl) return;

    let bgStyle = "";
    let borderStyle = "";

    // Ù…Ù†Ø·Ù‚ Ø§ÙˆÙ„ÙˆÛŒØª Ø§Ø³Ú©Ù„Ù¾
    if (mode === 'scalp' || mode === 'Ø§Ø³Ú©Ù¾') {
        bgStyle = "linear-gradient(to top, rgba(255, 49, 49, 0.5), rgba(10, 10, 12, 0.98))";
        borderStyle = "2px solid var(--neon-red)";
    } else {
        // Ù…Ù†Ø·Ù‚ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú©
        if (riskP <= 3) {
            bgStyle = "linear-gradient(to top, rgba(255, 49, 49, 0.4), rgba(10, 10, 12, 0.98))";
            borderStyle = "2px solid var(--neon-red)";
        } else if (riskP <= 4) {
            bgStyle = "linear-gradient(to top, rgba(255, 230, 0, 0.3), rgba(10, 10, 12, 0.98))";
            borderStyle = "2px solid var(--neon-yellow)";
        } else {
            bgStyle = "linear-gradient(to top, rgba(57, 255, 20, 0.4), rgba(10, 10, 12, 0.98))";
            borderStyle = "2px solid var(--neon-green)";
        }
    }

    footerEl.style.background = bgStyle;
    footerEl.style.borderTop = borderStyle;
    footerEl.style.transition = "all 0.2s ease"; // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†Ø±Ù…
}


</script>

</body>
</html>